% ============================================================================
%  Post-Quantum Secure MAVLink Tunnel
%  A Comprehensive Technical Reference
%
%  LaTeX master document — compile with:
%    latexmk -pdf -interaction=nonstopmode main.tex
% ============================================================================
\documentclass[12pt,a4paper,twoside,openright]{book}

% ── Encoding & Fonts ────────────────────────────────────────────────────────
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}            % Latin Modern — clean, scalable
\usepackage{microtype}          % Microtypographic improvements

% ── Page Geometry ───────────────────────────────────────────────────────────
\usepackage[
  a4paper,
  top=2.5cm,
  bottom=2.5cm,
  left=3cm,
  right=2.5cm,
  headheight=15pt
]{geometry}

% ── Language ────────────────────────────────────────────────────────────────
\usepackage[english]{babel}

% ── Mathematics ─────────────────────────────────────────────────────────────
\usepackage{amsmath,amssymb,amsthm}
\usepackage{mathtools}

% ── Graphics & Color ────────────────────────────────────────────────────────
\usepackage{graphicx}
\usepackage[dvipsnames,svgnames,x11names]{xcolor}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,shapes.geometric,calc,fit,
                 decorations.pathreplacing,backgrounds,matrix}

% ── Tables ──────────────────────────────────────────────────────────────────
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{array}

% ── Listings (Source Code) ──────────────────────────────────────────────────
\usepackage{listings}
\usepackage{listingsutf8}

\definecolor{codebg}{HTML}{F8F8F8}
\definecolor{codeframe}{HTML}{CCCCCC}
\definecolor{codecomment}{HTML}{6A9955}
\definecolor{codestring}{HTML}{CE9178}
\definecolor{codekeyword}{HTML}{569CD6}
\definecolor{codenumber}{HTML}{B5CEA8}

\lstset{
  backgroundcolor=\color{codebg},
  frame=single,
  rulecolor=\color{codeframe},
  basicstyle=\ttfamily\small,
  keywordstyle=\color{codekeyword}\bfseries,
  commentstyle=\color{codecomment}\itshape,
  stringstyle=\color{codestring},
  numberstyle=\tiny\color{codenumber},
  numbers=left,
  numbersep=8pt,
  breaklines=true,
  breakatwhitespace=false,
  showstringspaces=false,
  tabsize=4,
  captionpos=b,
  aboveskip=1em,
  belowskip=1em,
  xleftmargin=2em,
  framexleftmargin=1.5em,
}

\lstdefinestyle{python}{
  language=Python,
  morekeywords={self,True,False,None,as,with,async,await,yield,from,import},
}

\lstdefinestyle{typescript}{
  language=Java,  % close enough for TS highlighting
  morekeywords={interface,type,export,const,let,async,await,import,from,
                extends,implements,readonly,string,number,boolean,any,void,
                null,undefined,Record,Partial,Promise},
}

\lstdefinestyle{json}{
  basicstyle=\ttfamily\small,
  string=[s]{"}{"},
  stringstyle=\color{codestring},
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
}

\lstdefinestyle{bash}{
  language=bash,
  morekeywords={sudo,ssh,cd,source,python,conda,activate,git,pip},
}

% ── Algorithms / Pseudocode ────────────────────────────────────────────────
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\SetAlgoSkip{medskip}

% ── Cross-references & Hyperlinks ──────────────────────────────────────────
\usepackage[
  colorlinks=true,
  linkcolor=NavyBlue,
  citecolor=ForestGreen,
  urlcolor=RoyalBlue,
  bookmarks=true,
  bookmarksnumbered=true,
  pdfstartview=FitH
]{hyperref}
\usepackage[nameinlink,capitalise]{cleveref}

% ── Bibliography ────────────────────────────────────────────────────────────
\usepackage[
  backend=biber,
  style=ieee,
  sorting=nyt,
  maxbibnames=6,
  doi=true,
  isbn=false,
  url=true,
]{biblatex}
\addbibresource{references.bib}

% ── Headers & Footers ──────────────────────────────────────────────────────
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\small\nouppercase{\leftmark}}
\fancyhead[RO]{\small\nouppercase{\rightmark}}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}

% ── Theorem-like environments ──────────────────────────────────────────────
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\newtheorem{example}{Example}[chapter]

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}[theorem]{Lemma}

\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\newtheorem*{note}{Note}
\newtheorem*{warning}{Warning}

% ── Custom boxes ───────────────────────────────────────────────────────────
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable}

\newtcolorbox{keyinsight}[1][]{%
  enhanced, breakable,
  colback=blue!5, colframe=NavyBlue,
  fonttitle=\bfseries,
  title={Key Insight},
  #1
}

\newtcolorbox{analogy}[1][]{%
  enhanced, breakable,
  colback=green!5, colframe=ForestGreen,
  fonttitle=\bfseries,
  title={Analogy},
  #1
}

\newtcolorbox{designdecision}[1][]{%
  enhanced, breakable,
  colback=orange!5, colframe=BurntOrange,
  fonttitle=\bfseries,
  title={Design Decision},
  #1
}

\newtcolorbox{securitynote}[1][]{%
  enhanced, breakable,
  colback=red!5, colframe=BrickRed,
  fonttitle=\bfseries,
  title={Security Note},
  #1
}

\newtcolorbox{implementationnote}[1][]{%
  enhanced, breakable,
  colback=purple!5, colframe=RoyalPurple,
  fonttitle=\bfseries,
  title={Implementation Note},
  #1
}

% ── Miscellaneous ──────────────────────────────────────────────────────────
\usepackage{enumitem}
\usepackage{siunitx}
\usepackage{subcaption}
\usepackage{float}
\usepackage{pdfpages}
\usepackage{epigraph}
\usepackage{etoolbox}

% Depth of table of contents
\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

% Prevent widows and orphans
\widowpenalty=10000
\clubpenalty=10000

% ── Custom Commands ────────────────────────────────────────────────────────
\newcommand{\suiteid}[1]{\texttt{#1}}
\newcommand{\configkey}[1]{\texttt{CONFIG["{#1}"]}}
\newcommand{\filename}[1]{\texttt{#1}}
\newcommand{\classname}[1]{\texttt{#1}}
\newcommand{\funcname}[1]{\texttt{#1}}
\newcommand{\pqctunnel}{\textsc{PQC-Tunnel}}

% ============================================================================
%  DOCUMENT BEGIN
% ============================================================================
\begin{document}

% ── Front Matter ───────────────────────────────────────────────────────────
\frontmatter

\input{chapters/titlepage}
\input{chapters/dedication}
\input{chapters/preface}

\tableofcontents
\listoffigures
\listoftables
\listofalgorithms

\input{chapters/glossary}

% ── Main Matter ────────────────────────────────────────────────────────────
\mainmatter

% Part I: Foundations
\part{Foundations}
\input{chapters/ch01-introduction}
\input{chapters/ch02-networking}
\input{chapters/ch03-cryptography}
\input{chapters/ch04-post-quantum}

% Part II: The Domain
\part{The Domain: Drones and Secure Communication}
\input{chapters/ch05-mavlink}
\input{chapters/ch06-architecture}

% Part III: The Implementation
\part{The Implementation}
\input{chapters/ch07-handshake}
\input{chapters/ch08-aead-framing}
\input{chapters/ch09-proxy-engine}
\input{chapters/ch10-suites}

% Part IV: Orchestration and Measurement
\part{Orchestration and Measurement}
\input{chapters/ch11-scheduler}
\input{chapters/ch12-metrics}
\input{chapters/ch13-dashboard}

% Part V: Engineering and Reflection
\part{Engineering and Reflection}
\input{chapters/ch14-engineering}
\input{chapters/ch15-conclusion}

% ── Appendices ─────────────────────────────────────────────────────────────
\appendix
\input{chapters/appendix-a-config}
\input{chapters/appendix-b-wire}
\input{chapters/appendix-c-schema}

% ── Back Matter ────────────────────────────────────────────────────────────
\backmatter

\printbibliography[heading=bibintoc,title={Bibliography}]

\input{chapters/colophon}

\end{document}
