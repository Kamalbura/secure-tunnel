# MAVLink vs. Benchmark Delta Analysis

## Executive Summary

This report documents the structural and configuration differences between the "Control/MAVLink" scripts (`sdrone_mav.py`, `sgcs_mav.py`) and the "Benchmark" scripts (`sdrone_bench.py`, `sgcs_bench.py`).

**Findings:**
The analysis confirms that the Benchmark scripts fail to observe MAVLink heartbeats due to two fundamental architectural gaps:
1.  **GCS Side (Configuration):** A critical port mismatch disconnects the Crypto Proxy from the MAVProxy application.
2.  **Drone Side (Lifecycle):** The benchmark script (`sdrone_bench.py`) completely omits the MAVProxy instance required to source MAVLink data from the Flight Controller.

## Component Delta Analysis

### 1. GCS Architecture (`sgcs_mav.py` vs `sgcs_bench.py`)

| Feature | `sgcs_mav.py` (Working) | `sgcs_bench.py` (Broken MAVLink) | Impact |
| :--- | :--- | :--- | :--- |
| **MAVProxy Input** | `udpin:0.0.0.0:47002` | `udp:127.0.0.1:14550` | **CRITICAL FAILURE** |
| **Logic** | Uses `GCS_PLAINTEXT_RX` (47002) from `config.py` as `master`. | Hardcodes `MAVLINK_INPUT_PORT = 14550`. | Proxy sends to 47002; MAVProxy listens on 14550. No data flows. |
| **MAVProxy Output** | `udp:127.0.0.1:14550` (Control) + `14552` (Sniff) | `udp:127.0.0.1:14552` (Sniff only) | Application layer (QGC) also disconnected in bench mode. |
| **Stdout/Stderr** | Handled natively + `TERM=dumb` | Redirected to log file (Fixed in prev. step) | Was causing crash; now fixed. |

**Code Evidence:**
*   `sgcs_mav.py`: `listen_port = int(CONFIG.get("GCS_PLAINTEXT_RX", GCS_PLAIN_RX_PORT))` -> 47002
*   `sgcs_bench.py`: `MAVLINK_INPUT_PORT = 14550` ... `--master=udp:127.0.0.1:14550`

### 2. Drone Architecture (`sdrone_mav.py` vs `sdrone_bench.py`)

| Feature | `sdrone_mav.py` (Working) | `sdrone_bench.py` (Broken MAVLink) | Impact |
| :--- | :--- | :--- | :--- |
| **MAVProxy Instance** | Starts persistent MAVProxy via `DroneScheduler`. | **MISSING** | **CRITICAL FAILURE** |
| **Source of MAVLink** | `/dev/ttyACM0` (FC) -> UDP 47003 | None | No entity reads from FC or generates MAVLink heartbeats. |
| **Data Flow** | FC -> MAVProxy -> Proxy (47003) | TrafficGen -> Proxy (47003) | Bench sends dummy traffic, not MAVLink. |
| **Heartbeats** | Generated by connected FC or MAVProxy. | None generated. | GCS receives nothing because nothing is sent. |

**Code Evidence:**
*   `sdrone_mav.py`: Includes `start_persistent_mavproxy()` which launches `MAVProxy.mavproxy`.
*   `sdrone_bench.py`: Contains `MavLinkMetricsCollector` (listener) and `UdpEchoServer` (reflector), but *no* MAVProxy launcher or Flight Controller interface.

## Root Cause Hypotheses (Ranked)

### RC1: GCS Port Mismatch (Confirmed)
The GCS benchmark script explicitly listens on the wrong port. The Crypto Proxy delivers decrypted packets to `localhost:47002` (as defined in `core/config.py`), but `sgcs_bench.py` configures MAVProxy to listen on `localhost:14550`.
*   **Probability:** 100% (Confirmed by code review).
*   **Fix:** Change `MAVLINK_INPUT_PORT` in `sgcs_bench.py` to `47002`.

### RC2: Drone Missing MAVProxy (Confirmed)
The Drone benchmark script does not start MAVProxy. Even if the GCS port were fixed, the Drone is sending *synthetic UDP traffic* (generated by `sdrone_bench.py` traffic generator) or *echoing* GCS packets. It is *not* reading from the Pixhawk Flight Controller.
*   **Probability:** 100% (Confirmed by code review).
*   **Fix:** `sdrone_bench.py` must either:
    1.  Launch MAVProxy in parallel to bridge the FC (complex, requires exclusivity on serial port).
    2.  Or, rely on `sdrone_mav.py` running in background (unlikely, usually exclusive).
    3.  Or, we accept that "Benchmark" mode is for *synthetic* traffic, not *real* flight control, and we should inject synthetic heartbeats if we want to test MAVLink metrics.

## Recommended Resolution Plan

1.  **Immediate Fix (GCS):** Update `sgcs_bench.py` to listen on port `47002` (`GCS_PLAINTEXT_RX`). This will allow *any* traffic coming from the proxy to reach MAVProxy.
2.  **Architecture Decision (Drone):**
    *   If the goal is to benchmark *synthetic* traffic: `sdrone_bench.py` is correct, but we won't see "Real" heartbeats. We should inject *synthetic* heartbeats into the stream if we want to verify the specific "MAVLink Heartbeat" metric.
    *   If the goal is to benchmark *live* flight traffic: `sdrone_bench.py` needs to incorporate `MavProxyManager` logic to bridge the serial port.

**Proposed Next Step:**
Fix the GCS port mismatch first. It is a definite bug. Then, run the benchmark again. If heartbeats are still missing (likely), it confirms that `sdrone_bench.py` needs to generate them.
